# 書式付き文字列

{% raw %}

Carp には文字列を整形する方法が 2 つあり、`fmt` と `fstr` が用意されています。本書では両者の違いと使い方を詳しく解説します。

## `fmt`

`fmt` は `fstr` よりも詳細な制御が可能ですが、その分データに関する知識が必要になります。

```clojure
(fmt "this is an integer %d and this is a string %s." 1 "hi")
```

基本的な挙動は C の[`printf`](https://en.wikipedia.org/wiki/Printf_format_string) と同様です。フォーマット文字列に含まれる変換指定子の個数と、渡す引数の個数が一致するかどうかを `fmt` が検証します。

`fmt` に渡すすべての引数は `format` インタフェースを実装している必要があります。インタフェースの定義は次のとおりです。

```clojure
(definterface format (Fn [String a] String)
```

各型はフォーマット指定子を受け取り、それに沿った整形を行う必要があります。そのため、利用可能な変換指定子は型ごとの `format` 実装に依存します。標準ライブラリが提供する型は、おおむね C と同じ指定子をサポートしています。

`format` の多くの実装は `snprintf` などの関数を利用しているため、誤った変換指定子を使うと問題を引き起こす可能性がある点に注意してください。

また、`fmt` に渡すフォーマット文字列はリテラルでなければなりません。

## `fstr`

`fmt` と同様に、`fstr` もリテラル文字列を受け取ります。違いはインタフェースがよりシンプルな点で、式を文字列内に直接埋め込み、`str` を使って整形します。そのため、`fstr` に埋め込む各式の戻り値は `str` インタフェースを実装している必要があります。

```clojure
(def x 1)
(def y "hi")

(fstr "this is an integer {x} and this is the first character of a string {(head x)}")
```

`fstr` の内部には、構文的に正しい任意の式を埋め込めます。式は `{}` で囲んで区切ります。孤立した `}` はリテラルとして扱われ、リテラルの `{` を書きたい場合は `{{` とエスケープします。

```clojure
(fstr "{{}") ; => {}
```

技術的には複雑な式や複数行の式を埋め込むこともできますが、可読性が落ちるため推奨されません。

{% endraw %}
