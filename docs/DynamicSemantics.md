# 動的セマンティクス

このドキュメントは、Carp の動的評価器（Eval.hs で定義）を書き直し、より一貫性があって驚きの少ない挙動を実現するための指針をまとめたものです。

## 改修の目的
* 動的評価に関する既知のバグを修正する（「関連 issue」を参照）
* 動的 Lisp として期待される機能を追加する
* 将来的に動的評価器へ機能を追加しやすくする

## 関連 issue
* https://github.com/carp-lang/Carp/issues/560
* https://github.com/carp-lang/Carp/issues/555
* https://github.com/carp-lang/Carp/issues/545
* https://github.com/carp-lang/Carp/issues/476
* https://github.com/carp-lang/Carp/issues/556
* https://github.com/carp-lang/Carp/issues/659
* https://github.com/carp-lang/Carp/issues/660
* https://github.com/carp-lang/Carp/issues/453

## 追加したい機能（現状は未実装）
* 動的言語およびマクロシステムの使い方を解説するドキュメント
* 準クォート、スプライシング、詳細なエラー報告などを含む本格的なマクロ機能
* 動的スタックトレース
* ユーザ定義名の補完

<hr>

## 目次
[TODO]

## 0. 用語
* form : テキストとして表現された Carp の任意の有効なデータ構造。
* top level : 別の form に埋め込まれていない form。
* Static Carp : Carp 言語のコンパイル済みバージョン。
* Dynamic Carp : Carp 言語のインタプリタ版（関数型で GC あり）。

## 1. スコープ規則
関連 issue:
* https://github.com/carp-lang/Carp/issues/659

設問:
#### Carp はシンボル X の値をどのように決定するか？
レキシカルスコープで解決します（現在のスコープから始め、外側へ、最後はグローバルスコープまで探索）。スコープを生成するものは以下の通りです。
- 関数定義（`defn`, `defndynamic`, `fn`）
- `let`
- モジュール

#### シンボル X の値を設定するには？
`(set! <symbol> <value>)`

#### 予約語はあるか？
あります（詳細は Parsing モジュールを参照）。現在の予約語は以下の通りです。
- `defn`
- `def`
- `do`
- `while`
- `fn`
- `let`
- `break`
- `if`
- `match`
- `true`
- `false`
- `address`
- `set!`
- `the`
- `ref`
- `deref`
- `with`

実際にはさらに多くの識別子を予約語扱いにすべきです。また、`defmacro` 内の `:rest` トークンも予約されています。

#### キーワードは存在するか？
現状はありません。将来的にマクロで導入される可能性があります（例: https://gist.github.com/sdilts/73a811a633bb0ef3dd7e31b84a138a5a）。

#### 動的 Carp と静的 Carp で名前空間は異なるか？
同じモジュールを共有しますが、動的探索は動的関数のみ、静的探索は静的関数のみを見つけます。

### 1.1 グローバル変数
設問:
#### グローバル変数は可変か？
はい。

#### どのように変更され、いつ反映されるか？
`set!` を使います。内部的には `IORef` を用いており、変更は即座に反映されます。

#### グローバル変数のスコープはレキシカルかダイナミックか？
レキシカルです（動的スコープは存在しません）。

### 1.2 ローカル変数
設問:
#### ローカル変数は可変か？
はい。

#### ローカル変数はいつスコープに入り、いつ抜けるか？
レキシカルスコープの規則に従います。関数と `let` が新しい変数を導入します。

#### クロージャとは？クロージャ内の変数に関する重要なルールは？
キャプチャされた変数は可変ではありません。動的ラムダは `(fn ...)` が評価された時点での環境全体を捕捉します。

### 1.3 名前空間の規則
設問:
#### `Foo` モジュールと `Bar` モジュールの双方に `a` が存在するとき、それぞれをどう参照するか？
`Foo.a`, `Bar.a` のようにドット記法を使います。`(use <module>)` を利用するとモジュール名の指定を省略できます。

#### 複数モジュールをインポートし、同名シンボルがあるとどうなるか？
シンボル解決時に実行時エラーになります。

#### `Foo.a` と `Bar.a` が存在するとき、`a` はどちらを参照するか？
どちらのモジュールも `use` していなければ参照できません。どちらか一方だけを `use` していればそちらを参照し、両方を `use` している場合は曖昧なためエラーになります。

#### 関数と変数は同じ名前空間に属するか？
はい。同じ名前空間にあります。型は別の名前空間です。

### 1.4 定義
設問:
#### どのような定義があり、どう作られるか？

動的コンテキスト:
- `defndynamic`（動的関数を定義）
- `defdynamic`（動的グローバル変数を定義）
- `defmacro`（マクロを定義）

静的コンテキスト:
- `defn`（静的関数を定義）
- `def`（静的グローバル変数を定義）
- `deftype`（積型・和型を定義）
- `register`（外部関数を利用可能にする）

共通:
- `defmodule`

## 2. 評価規則
関連 issue:
* https://github.com/carp-lang/Carp/issues/555

設問:
#### マクロはいつ評価されるか？
#### シンボルはいつ評価されるか？
#### form はいつ評価されるか？
#### form は左から右、右から左のどちらで評価されるか？
#### エラー報告はどのように行われるか？

### 2.1 マクロ
設問:
* マクロとは何か？
* マクロ展開時に利用できる関数は？
* 準クォートとは？構文は？
* スプライシングとは？構文は？

### 2.2 REPL
設問:
* REPL はコードを動的／静的コンテキストのどちらで評価するかをどう判定するか？
* いつ動的コンテキストで実行し、いつ静的コンテキストで実行するかを決定するか？
* いつ動的コンテキストで実行し、いつ静的コンテキストで実行するかを決定するか？

## 3. 型
関連 issue:
* [#560 Add Reflection Module Proposal](https://github.com/carp-lang/Carp/issues/560)

設問:
* どのような型が利用できるか？
* form はいつ型チェックされるか？
* 特定の型をどう参照するか？型は[第一級オブジェクト](https://en.wikipedia.org/wiki/First-class_citizen)か？
